
bash
#!/usr/bin/env bash
#═══════════════════════════════════════════════════════════════════════════════
#                     Phantom Server v3.0 管理脚本
#═══════════════════════════════════════════════════════════════════════════════

set -e

VERSION="3.0.0"
GITHUB_REPO="anthropics/phantom-server"
INSTALL_DIR="/opt/phantom"
CONFIG_DIR="/etc/phantom"
BINARY_NAME="phantom-server"
CONFIG_FILE="${CONFIG_DIR}/config.yaml"
SERVICE_NAME="phantom"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info()  { echo -e "${GREEN}[✓]${NC} $1"; }
log_warn()  { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[✗]${NC} $1"; }
log_step()  { echo -e "${BLUE}[→]${NC} $1"; }

check_root() {
    [[ $EUID -ne 0 ]] && { log_error "请使用 root 权限运行"; exit 1; }
}

detect_arch() {
    case $(uname -m) in
        x86_64|amd64)  ARCH="amd64" ;;
        aarch64|arm64) ARCH="arm64" ;;
        *) log_error "不支持的架构"; exit 1 ;;
    esac
}

get_public_ip() {
    curl -s --connect-timeout 5 https://api.ipify.org 2>/dev/null || \
    curl -s --connect-timeout 5 https://ifconfig.me/ip 2>/dev/null || echo ""
}

generate_psk() {
    openssl rand -base64 32
}

is_installed() {
    [[ -f "${INSTALL_DIR}/${BINARY_NAME}" ]] && [[ -f "$CONFIG_FILE" ]]
}

is_running() {
    systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null
}

do_install() {
    check_root
    detect_arch
    
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════════════════╗"
    echo "║            Phantom Server v${VERSION} 安装向导                      ║"
    echo "╚═══════════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
    
    # 获取 IP
    log_step "获取服务器 IP..."
    SERVER_IP=$(get_public_ip)
    [[ -z "$SERVER_IP" ]] && { read -rp "请输入服务器 IP: " SERVER_IP; }
    log_info "服务器 IP: $SERVER_IP"
    
    # 端口
    read -rp "UDP 端口 [54321]: " PORT
    PORT=${PORT:-54321}
    
    # 日志级别
    read -rp "日志级别 (debug/info/error) [info]: " LOG_LEVEL
    LOG_LEVEL=${LOG_LEVEL:-info}
    
    log_step "下载程序..."
    mkdir -p "$INSTALL_DIR" "$CONFIG_DIR"
    
    URL="https://github.com/${GITHUB_REPO}/releases/download/v${VERSION}/${BINARY_NAME}-linux-${ARCH}.tar.gz"
    if curl -fSL --progress-bar -o /tmp/phantom.tar.gz "$URL" 2>/dev/null; then
        tar -xzf /tmp/phantom.tar.gz -C "$INSTALL_DIR"
        rm /tmp/phantom.tar.gz
    else
        URL="https://github.com/${GITHUB_REPO}/releases/download/v${VERSION}/${BINARY_NAME}-linux-${ARCH}"
        curl -fSL --progress-bar -o "${INSTALL_DIR}/${BINARY_NAME}" "$URL"
    fi
    chmod +x "${INSTALL_DIR}/${BINARY_NAME}"
    ln -sf "${INSTALL_DIR}/${BINARY_NAME}" "/usr/local/bin/${BINARY_NAME}"
    
    log_step "生成配置..."
    PSK=$(generate_psk)
    
    cat > "$CONFIG_FILE" << EOF
listen: ":${PORT}"
psk: "${PSK}"
time_window: 30
log_level: "${LOG_LEVEL}"
EOF
    chmod 600 "$CONFIG_FILE"
    
    log_step "安装服务..."
    cat > "/etc/systemd/system/${SERVICE_NAME}.service" << EOF
[Unit]
Description=Phantom Server
After=network.target

[Service]
Type=simple
ExecStart=${INSTALL_DIR}/${BINARY_NAME} -c ${CONFIG_FILE}
Restart=always
RestartSec=3
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    systemctl enable "$SERVICE_NAME" --quiet
    systemctl start "$SERVICE_NAME"
    
    # 防火墙
    command -v ufw &>/dev/null && ufw allow "$PORT/udp" &>/dev/null
    command -v firewall-cmd &>/dev/null && {
        firewall-cmd --permanent --add-port="$PORT/udp" &>/dev/null
        firewall-cmd --reload &>/dev/null
    }
    
    sleep 2
    
    if is_running; then
        LINK="phantom://$(echo -n "{\"v\":3,\"server\":\"${SERVER_IP}\",\"port\":${PORT},\"psk\":\"${PSK}\"}" | base64 -w 0)"
        
        echo ""
        echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${GREEN}║                     安装完成！                                    ║${NC}"
        echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════════╝${NC}"
        echo ""
        echo -e "  服务器: ${CYAN}${SERVER_IP}:${PORT}${NC}"
        echo -e "  PSK:    ${YELLOW}${PSK}${NC}"
        echo ""
        echo -e "  分享链接:"
        echo -e "  ${GREEN}${LINK}${NC}"
        echo ""
        echo -e "  管理命令:"
        echo -e "    systemctl start/stop/restart ${SERVICE_NAME}"
        echo -e "    journalctl -u ${SERVICE_NAME} -f"
        echo ""
    else
        log_error "启动失败，请检查: journalctl -u ${SERVICE_NAME}"
    fi
}

do_uninstall() {
    check_root
    
    systemctl stop "$SERVICE_NAME" 2>/dev/null || true
    systemctl disable "$SERVICE_NAME" 2>/dev/null || true
    rm -f "/etc/systemd/system/${SERVICE_NAME}.service"
    systemctl daemon-reload
    rm -rf "$INSTALL_DIR"
    rm -f "/usr/local/bin/${BINARY_NAME}"
    
    read -rp "删除配置文件? [y/N]: " r
    [[ "$r" =~ ^[Yy]$ ]] && rm -rf "$CONFIG_DIR"
    
    log_info "卸载完成"
}

do_status() {
    if is_installed; then
        echo -e "安装: ${GREEN}是${NC}"
        if is_running; then
            echo -e "状态: ${GREEN}运行中${NC}"
            PID=$(systemctl show -p MainPID --value "$SERVICE_NAME")
            echo -e "PID:  ${CYAN}${PID}${NC}"
        else
            echo -e "状态: ${RED}已停止${NC}"
        fi
    else
        echo -e "安装: ${RED}否${NC}"
    fi
}

case "${1:-}" in
    install)   do_install ;;
    uninstall) do_uninstall ;;
    status)    do_status ;;
    start)     systemctl start "$SERVICE_NAME" && log_info "已启动" ;;
    stop)      systemctl stop "$SERVICE_NAME" && log_info "已停止" ;;
    restart)   systemctl restart "$SERVICE_NAME" && log_info "已重启" ;;
    logs)      journalctl -u "$SERVICE_NAME" -f ;;
    *)
        echo "Phantom Server v${VERSION}"
        echo ""
        echo "用法: $0 <命令>"
        echo ""
        echo "命令:"
        echo "  install    安装"
        echo "  uninstall  卸载"
        echo "  status     状态"
        echo "  start      启动"
        echo "  stop       停止"
        echo "  restart    重启"
        echo "  logs       日志"
        ;;
esac


















